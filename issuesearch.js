var H=0,i=class{wraps;children=[];id="L"+H++;constructor(e){this.wraps=e,this.wraps.id=this.id}add(e){if(e!=null){let t;typeof e=="string"?t=new p(e):t=e,this.children.push(t),this.wraps.appendChild(t.wraps)}else throw new Error("node undefined");return this}remove(e){let t=this.children.indexOf(e);if(t<0)throw new Error("node not a child of this node");this.children.splice(t,1),this.wraps.removeChild(e.wraps)}with(...e){return e.forEach(t=>{this.add(t)}),this}style(e){return e(this.wraps.style),this}class(e){return this.wraps.classList.add(e),this}},A=function(s){return s.THIS_TAB="_this",s.NEW_TAB="_blank",s.OUT_FRAME="_parent",s.NOT_FRAME="_top",s}(A||{}),u=class extends i{constructor(e){let t=document.createElement("a");t.classList.add("LLink"),super(t),e!=null&&this.add(e)}set destination(e){this.wraps.href=e}get destination(){return this.wraps.href}set target(e){this.wraps.target=e}get target(){return this.wraps.target}to(e,t=A.NEW_TAB){return this.destination=e,this.target=t,this}},k=class extends i{constructor(){let e=document.createElement("div");e.classList.add("LContainer"),super(e)}};var f=class extends k{constructor(){super(),this.wraps.classList.add("LRow")}},_=class extends i{constructor(){let e=document.createElement("table");e.classList.add("LTable"),super(e)}},L=class extends i{constructor(){let e=document.createElement("tr");e.classList.add("LTableRow"),super(e)}},o=class extends i{constructor(){let e=document.createElement("td");e.classList.add("LTableCell"),super(e)}},y=class extends i{_text="";get text(){return this._text}set text(e){this._text=e,this.wraps.textContent=e}},p=class extends y{constructor(e=""){let t=document.createElement("span");t.classList.add("LLabel"),super(t),this.text=e}},$=class extends y{constructor(e,t){let n=document.createElement("button");n.textContent=e,n.addEventListener("click",t),n.classList.add("LButton"),super(n),this.text=e}},v=class extends y{constructor(e="text"){let t=document.createElement("input");t.type=e,t.classList.add("LInput"),super(t)}set placeholder(e){this.wraps.placeholder=e}get value(){return this.wraps.value}set value(e){this.wraps.value=e,this.watching.forEach(t=>t(e))}watching=[];watch(e){this.watching.push(e),this.wraps.oninput=t=>{e(this.value)},e(this.value)}};var a=new i(document.body);a.with(new u("TypeScript source here!").to("https://tangled.sh/@hotsocket.fyi/domlink/blob/main/src/issuesearch.ts"));async function I(s,e,t=null){let n=`${s}/xrpc/${e}`;if(t){let w=new URLSearchParams;for(let m in t)w.append(m,t[m].toString());n+="?"+w.toString()}return await(await fetch(n)).json()}var h=[],R="https://slingshot.microcosm.blue",M="";async function D(s){let t=new URL(s).pathname.split("/"),n=t[1].substring(1),w=t[2];M=`https://tangled.sh/@${n}/${w}`,d.text="resolving owner did";let m=await I(R,"com.bad-example.identity.resolveMiniDoc",{identifier:n});d.text="finding repository";let j=(await I(m.pds,"com.atproto.repo.listRecords",{repo:m.did,collection:"sh.tangled.repo"})).records.find(r=>r.value.name==w),U=encodeURIComponent(j.uri);d.text="finding issues...";let b=await(await fetch(`https://constellation.microcosm.blue/links?target=${U}&collection=sh.tangled.repo.issue&path=.repo`)).json(),x=b.linking_records,E=b.cursor;for(;x.length<b.total&&E!=null;){d.text=`finding issues... (${x.length}/${b.total})`;let r=await(await fetch(`https://constellation.microcosm.blue/links?target=${U}&collection=sh.tangled.repo.issue&path=.repo&cursor=${E}`,{headers:{Accept:"application/json"}})).json();if(E=r.cursor,x=x.concat(r.linking_records),E==null)break}h=(await Promise.all(x.map(async r=>{let g=await Promise.race([I(R,"com.atproto.repo.getRecord",{repo:r.did,collection:r.collection,rkey:r.rkey}),new Promise((O,W)=>{setTimeout(O,2e3,null)})]);if(g==null)return console.log(`getRecord timed out: at://${r.did}/${r.collection}/${r.rkey}`),null;let c=g.value,B;try{B=await I(R,"com.bad-example.identity.resolveMiniDoc",{identifier:c.owner})}catch{return null}return d.text=`retrieved issue #${c.issueId} (not in order!)`,{handle:B.handle,issue:c}}))).filter(r=>r).sort((r,g)=>{let c=0;return r&&g&&(c=g.issue.issueId-r.issue.issueId),c}),d.text=`got ${h.length} issues!`}function N(s){let e=new _().add(new L().with(new o().add("Handle"),new o().add("Issue#"),new o().add("Title")));return s.forEach(t=>{if(t){let n=new L;n.with(new o().add(new u(t.handle).to(`https://tangled.sh/@${t.handle}`)),new o().add(new u(t.issue.issueId.toString()).to(`${M}/issues/${t.issue.issueId}`)),new o().add(t.issue.title)),e.add(n)}}),e}var P=new v,l,d=new p("waiting"),T=new $("GO!",async()=>{if(T.wraps.disabled=!0,l){try{a.remove(l)}catch{}l=null}h=[],C.style(s=>s.display="none");try{await D(P.value),l=N(h),C.style(s=>s.removeProperty("display"))}catch(s){l=new p("Failed"),console.error(s)}a.add(l),S.value="",T.wraps.disabled=!1}),S=new v;S.watch(s=>{h.length>0&&(l&&a.remove(l),s=s.toLowerCase(),l=N(h.filter(e=>e.issue.issueId==Number(e)||s.split(" ").every(t=>e.handle.toLowerCase().includes(t)||e.issue.title.toLowerCase().includes(t)||e.issue.body.toLowerCase().includes(t)))),a.add(l))});var C=new f().with("search",S);C.style(s=>s.display="none");a.add(new f().with("List issues for repo: ",P,T,d));a.add(C);
