"use strict";(()=>{var B=0,o=class{constructor(e){this.children=[];this.id="L"+B++;this.wraps=e,this.wraps.id=this.id}add(e){if(e!=null){let t;typeof e=="string"?t=new h(e):t=e,this.children.push(t),this.wraps.appendChild(t.wraps)}else throw new Error("node undefined");return this}remove(e){let t=this.children.indexOf(e);if(t<0)throw new Error("node not a child of this node");this.children.splice(t,1),this.wraps.removeChild(e.wraps)}with(...e){return e.forEach(t=>{this.add(t)}),this}style(e){return e(this.wraps.style),this}class(e){return this.wraps.classList.add(e),this}};var p=class extends o{constructor(e){let t=document.createElement("a");t.classList.add("LLink"),super(t),e!=null&&this.add(e)}set destination(e){this.wraps.href=e}get destination(){return this.wraps.href}set target(e){this.wraps.target=e}get target(){return this.wraps.target}to(e,t="_blank"){return this.destination=e,this.target=t,this}},M=class extends o{constructor(){let e=document.createElement("div");e.classList.add("LContainer"),super(e)}};var L=class extends M{constructor(){super(),this.wraps.classList.add("LRow")}},I=class extends o{constructor(){let e=document.createElement("table");e.classList.add("LTable"),super(e)}},x=class extends o{constructor(){let e=document.createElement("tr");e.classList.add("LTableRow"),super(e)}},l=class extends o{constructor(){let e=document.createElement("td");e.classList.add("LTableCell"),super(e)}},y=class extends o{constructor(){super(...arguments);this._text=""}get text(){return this._text}set text(t){this._text=t,this.wraps.textContent=t}},h=class extends y{constructor(e=""){let t=document.createElement("span");t.classList.add("LLabel"),super(t),this.text=e}},T=class extends y{constructor(e,t){let n=document.createElement("button");n.textContent=e,n.addEventListener("click",t),n.classList.add("LButton"),super(n),this.text=e}},f=class extends y{constructor(t="text"){let n=document.createElement("input");n.type=t,n.classList.add("LInput");super(n);this.watching=[]}set placeholder(t){this.wraps.placeholder=t}get value(){return this.wraps.value}set value(t){this.wraps.value=t,this.watching.forEach(n=>n(t))}watch(t){this.watching.push(t),this.wraps.oninput=n=>{t(this.value)},t(this.value)}};var a=new o(document.body);a.with(new p("TypeScript source here!").to("https://tangled.sh/@hotsocket.fyi/domlink/blob/main/src/issuesearch.ts"));async function R(s,e,t=null){let n=`${s}/xrpc/${e}`;if(t){let g=new URLSearchParams;for(let w in t)g.append(w,t[w].toString());n+="?"+g.toString()}return await(await fetch(n)).json()}var c=[],H="https://slingshot.microcosm.blue",A="";async function O(s){let t=new URL(s).pathname.split("/"),n=t[1].substring(1),g=t[2];A=`https://tangled.sh/@${n}/${g}`,d.text="resolving owner did";let w=await R(H,"com.bad-example.identity.resolveMiniDoc",{identifier:n});d.text="finding repository";let D=(await R(w.pds,"com.atproto.repo.listRecords",{repo:w.did,collection:"sh.tangled.repo"})).records.find(r=>r.value.name==g),$=encodeURIComponent(D.uri);d.text="finding issues...";let E=await(await fetch(`https://constellation.microcosm.blue/links?target=${$}&collection=sh.tangled.repo.issue&path=.repo`)).json(),m=E.linking_records,v=E.cursor;for(;m.length<E.total&&v!=null;){d.text=`finding issues... (${m.length}/${E.total})`;let r=await(await fetch(`https://constellation.microcosm.blue/links?target=${$}&collection=sh.tangled.repo.issue&path=.repo&cursor=${v}`,{headers:{Accept:"application/json"}})).json();if(v=r.cursor,m=m.concat(r.linking_records),v==null)break}c=(await Promise.all(m.map(async r=>{let u=(await R(H,"com.atproto.repo.getRecord",{repo:r.did,collection:r.collection,rkey:r.rkey})).value,N;try{N=await R(H,"com.bad-example.identity.resolveMiniDoc",{identifier:u.owner})}catch{return null}return d.text=`retrieved issue #${u.issueId} (not in order!)`,{handle:N.handle,issue:u}}))).filter(r=>r).sort((r,_)=>{let u=0;return r&&_&&(u=_.issue.issueId-r.issue.issueId),u}),d.text=`got ${c.length} issues!`}function S(s){let e=new I().add(new x().with(new l().add("Handle"),new l().add("Issue#"),new l().add("Title")));return s.forEach(t=>{if(t){let n=new x;n.with(new l().add(new p(t.handle).to(`https://tangled.sh/@${t.handle}`)),new l().add(new p(t.issue.issueId.toString()).to(`${A}/issues/${t.issue.issueId}`)),new l().add(t.issue.title)),e.add(n)}}),e}var U=new f,i,d=new h("waiting"),k=new T("GO!",async()=>{if(k.wraps.disabled=!0,i){try{a.remove(i)}catch{}i=null}c=[],b.style(s=>s.display="none");try{await O(U.value),console.log(c),i=S(c),b.style(s=>s.removeProperty("display"))}catch(s){i=new h("Failed"),console.log(s)}a.add(i),C.value="",console.log(i),k.wraps.disabled=!1}),C=new f;C.watch(s=>{c.length>0&&(i&&a.remove(i),s=s.toLowerCase(),i=S(c.filter(e=>e.issue.issueId==Number(e)||s.split(" ").every(t=>e.handle.toLowerCase().includes(t)||e.issue.title.toLowerCase().includes(t)||e.issue.body.toLowerCase().includes(t)))),a.add(i))});var b=new L().with("search",C);b.style(s=>s.display="none");a.add(new L().with("List issues for repo: ",U,k,d));a.add(b);})();
